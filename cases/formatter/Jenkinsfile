pipeline {
    agent any
    options {
        timeout(time: 1, unit: 'HOURS')
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
    }

    parameters {
        string(name: 'HAXE_BRANCH', defaultValue: '', description: 'Haxe branch to build')
        string(name: 'HXB_ENABLED', defaultValue: '0', description: 'Haxe branch has hxb support')
    }

    environment {
        BENCHMARK_HAXE_PR = "${params.HAXE_BRANCH}"
        BENCHMARK_HAXE_HXB = "${params.HXB_ENABLED}"
    }

    stages {
        stage('checkout') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [[$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/HaxeBenchmarks/benchmark-runner.git']]])
            }
        }
        stage('clean hxb data') {
            steps {
                echo 'backup hxb data'
                sh '''
                    rm -rf cases/formatter/benchmark-run/hxb
                    rm -rf $BENCHMARK_RESULTS_BASE/formatter/hxb
                '''
            }
        }
        stage('run benchmark') {
            steps {
                echo 'run benchmark'
                sh '''
                    cd cases/formatter
                    mkdir -p data
                    ln -sfn $FORMATTER_INPUT_DATA_BASE/* data/
                    ../../scripts/tools/setup-data.sh formatter
                    lix download
                    haxe run.hxml
                '''
            }
        }
        stage('backup hxb data') {
            steps {
                echo 'backup hxb data'
                sh '''
                    cp -r cases/formatter/benchmark-run/hxb $BENCHMARK_RESULTS_BASE/formatter/ 2>/dev/null || :
                '''
            }
        }

        stage('trigger next benchmark') {
            when { 
                environment name: 'BENCHMARK_HAXE_PR', value: ''
            }
            steps {
                build job: 'Benchmark_formatter_noio', parameters: [string(name: 'HAXE_BRANCH', value: ""), string(name: 'HXB_ENABLED', value: "0")], wait: false
            }
        }
        stage('console output parsing') {
            steps {
                logParser projectRulePath: 'benchmark_log_parsing.txt', showGraphs: true, useProjectRule: true
            }
        }
    }
    post { 
        failure { 
            emailext attachLog: true, body: '', subject: '[Haxe-Benchmarks Formatter] failed build job', to: 'jenkins'
        }
    }
}
